<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>BattleDots in Backbone.js</title>

</head>
<body>

  <!-- ==== -->
  <!-- HTML -->
  <!-- ==== -->
 <section id="battledotsapp">
    <header id="header">
      <h2>BattleDots</h2>
    </header>
    <p> The goal of this game is to find all of the computer's dots before it can find yours. Select new game to begin. Click any of the check boxes to see if a dot exists at the location. Good luck!</p>
    <p>KEY: Correct selections are identified as <font color="lightgreen">*</font> while incorrect selections are idetified as <font color="red">X</font></p>
     <input id="new-game" type="button" value="New Game">
    <section id="main">
      <div id="game-board"></div>
    </section>
  </section>

  <!-- ========= -->
  <!-- Templates -->
  <!-- ========= -->
  <script type="text/template" id="board-template">
    <div class="grid">
    <h3>Computer</h3>
      <div id="row1">
      	<input type="checkbox" class="computer" id="1">
        <span id="box1">?</span>
      	<input type="checkbox" class="computer" id="2">
        <span id="box2">?</span>
      	<input type="checkbox" class="computer" id="3">
        <span id="box3">?</span>
      </div>
      <div id="row2">
      	<input type="checkbox" class="computer" id="4">
        <span id="box4">?</span>
      	<input type="checkbox" class="computer" id="5">
        <span id="box5">?</span>
      	<input type="checkbox" class="computer" id="6">
        <span id="box6">?</span>
      </div>
      <div id="row3">
      	<input type="checkbox" class="computer" id="7">
        <span id="box7">?</span>
      	<input type="checkbox" class="computer" id="8">
        <span id="box8">?</span>
      	<input type="checkbox" class="computer" id="9">
        <span id="box9">?</span>
      </div>
      <h3>Player</h3>
      <div id="row4">
      	<input type="checkbox" class="player" id="player1">
        <span id="playerBox1">?</span>
      	<input type="checkbox" class="player" id="player2">
        <span id="playerBox2">?</span>
      	<input type="checkbox" class="player" id="player3">
        <span id="playerBox3">?</span>
      </div>
      <div id="row5">
      	<input type="checkbox" class="player" id="player4">
        <span id="playerBox4">?</span>
      	<input type="checkbox" class="player" id="player5">
        <span id="playerBox5">?</span>
      	<input type="checkbox" class="player" id="player6">
        <span id="playerBox6">?</span>
      </div>
      <div id="row6">
      	<input type="checkbox" class="player" id="player7">
        <span id="playerBox7">?</span>
      	<input type="checkbox" class="player" id="player8">
        <span id="playerBox8">?</span>
      	<input type="checkbox" class="player" id="player9">
        <span id="playerBox9">?</span>
      </div>
      <p id="playerSelect">Select the four loctations you would like your dots to be located.</p>
    </div>
  </script> 

  <!-- ========= -->
  <!-- Libraries -->
  <!-- ========= -->
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js" type="text/javascript"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.3.3/underscore-min.js" type="text/javascript"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/0.9.2/backbone-min.js" type="text/javascript"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/backbone-localstorage.js/1.0/backbone.localStorage-min.js" type="text/javascript"></script>  
  
  <!-- ========== -->
  <!-- Javascript -->
  <!-- ========== -->

  <script type="text/javascript">
	'use strict';

  	var app = {};

 	//--------------
    // Models
    //--------------
  	app.Game = Backbone.Model.extend({
  		defaults: {
  			title: '',
  			completed: false,
  			playerDots: [1, 4, 8, 9],
  			computerDots: [2, 3, 6, 8],
  			computerChosen: []
  		},
  		toggle: function(){
  			this.save({completed: !this.get('completed')});
  		}
  	});

  	//--------------
    // Collections
    //--------------
  	app.GameList = Backbone.Collection.extend({
  		model: app.Game,
  		localStorage: new Store("backbone-game"),
  	});

  	app.gameList = new app.GameList();

  	//--------------
    // Views
    //--------------
    app.GameView = Backbone.View.extend({
    	tagName: 'div',
    	template: _.template($('#board-template').html()),
    	render: function(){
    		this.$el.html(this.template(this.model.toJSON()));
        this.$('.computer').prop('disabled', true);
    		return this;
    	},
    	initialize: function(){
    		this.model.on('change', this.render, this);
    		this.model.on('destroy', this.remove, this);
        this.model.set({'playerDots' : []});
        //this.model.set({'playerDots' : [1, 4, 8, 9]});
        var selection = Math.floor(Math.random()*9)+1;
        var array = [];
        while (array.length < 4){
          if (array.indexOf(selection) < 0) {
            array.push(selection);
          }
          selection = Math.floor(Math.random()*9)+1;
        }
        this.model.set({'computerDots' : array});
        this.model.set({'computerChosen' : []});
    	},
    	events: {
    		'click .computer': 'toggleCompleted',
    		'click .destroy': 'destroy',
        'click .player': 'addPlayerDots'
    	},
      addPlayerDots: function(e){
        var array = this.model.get('playerDots');
        var stringID =  $(e.currentTarget).attr("id");
        var id = parseInt(stringID.substr(stringID.length-1));
        array.push(id);
        if (array.length === 4){
          this.setPlayerDots(array);
        }
        var dotID = "#playerBox"+id;
        this.$(dotID).html("*");
      },
      setPlayerDots: function(array){
         $('.computer').prop('disabled', false);
         $('.player').prop('disabled', true);
         $('.player').prop('checked', false);
         this.model.set({'playerDots':array})
         for (var i = 1; i < 10; i++) {
           var id = "#playerBox"+i
           if (array.indexOf(i) > -1) {
              this.$(id).html("*");
            }
            else {
              this.$(id).html("X");
            }
         };
        this.$("#playerSelect").html("");
      },
    	toggleCompleted: function(e){
        var valid = this.model.get('computerDots');
        var chosen = parseInt($(e.currentTarget).attr("id"));
    		if (valid.indexOf(chosen) > -1) {
    			var id = $(e.currentTarget).attr("id");
          id = "#box"+id;
    			this.$(id).html("*");
          this.$(id).css('color','lightgreen');
          valid.splice(valid.indexOf(chosen), 1);
    		}
        else {
          var id = $(e.currentTarget).attr("id");
          id = "#box"+id;
          this.$(id).html("X");
          this.$(id).css('color','red');
        }
        $(e.currentTarget).prop('disabled', true);
        this.checkGame('player');
    	},
      computerSelect: function(){
        var selection = Math.floor(Math.random()*9)+1;
        var array = this.model.get('computerChosen');
        while (array.indexOf(selection) > -1) {
          if (array.length > 8){
            break;
          }
          selection = Math.floor(Math.random()*9)+1;
        }
        array.push(selection);
        var validPlayer = this.model.get('playerDots');
        if (validPlayer.indexOf(selection) > -1) {
          var id = "#playerBox"+selection;
          this.$(id).html("*");
          this.$(id).css('color','lightgreen');
          validPlayer.splice(validPlayer.indexOf(selection), 1);
        }
        else {
          id = "#playerBox"+selection;
          this.$(id).html("X");
          this.$(id).css('color','red');
        }
        var boxID = "player"+selection;
        document.getElementById(boxID).checked = true;
         this.checkGame('computer');
      },
      checkGame: function(turn){
        var playerDots = this.model.get('playerDots');
        var computersDots = this.model.get('computerDots');
        if (playerDots.length < 1){
          this.gameOver('Computer');
        }
        else if (computersDots.length < 1){
          this.gameOver('Player');
        }
        else{
          if (turn === 'player') {
            this.computerSelect();
          }
        }
      },
      gameOver: function(winner){
        $('.computer').prop('disabled', true);
        this.$el.append("<p>Game over! "+winner+" is the winner.</p>");
      },
    	destroy: function(){
    		this.model.destroy();
    	}
    });



    app.AppView = Backbone.View.extend({
    	el: '#battledotsapp',
    	initialize: function() {
    		this.input = this.$('#new-game');

    		app.gameList.on('add', this.addOne, this);
    		app.gameList.fetch();
    	},
    	events: {
    		'click #new-game': 'createGame'
    	},
    	createGame: function(e){
    		app.gameList.create(this.newAttributes());
    		//this.input.val('New Game');
    	},
    	addOne: function(game){
    		var view = new app.GameView({model: game});
    		$('#game-board').html(view.render().el);
    	},
    	newAttributes:function(){
    		return{
    			title: this.input.val().trim(),
    			completed: false
    		}
    	}
    });

    //--------------
    // Initializers
    //--------------  
    app.appView = new app.AppView();
  </script>

</body>
</html>